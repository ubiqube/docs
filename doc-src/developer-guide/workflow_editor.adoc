= Workflow Editor
:doctype: book
:imagesdir: ./resources/
ifdef::env-github,env-browser[:outfilesuffix: .adoc]
:toc: left
:toclevels: 4 
:source-highlighter: pygments


The workflow editor is a web based UI tool for designing, developping, testing and releasing automation workflows

With the workflow editor, you can create new workflows or edit existing workflows.

This document explains how to use the editor to design workflow and implement the in PHP or in Python.

The Workflow designer and execution engine are located, in the architecture layer, between the BPM and the Microservice

image:images/workflow_overall_architecture.png[width=80%] 

== Workflow overview

A workflow is a automation entity that can be used to automates all sort of simple to complex processes.

A workflow is defined by

- a set of variable that can be used to hold the state of a workflow instance.
- a set of processes made out of tasks. This is where the execution coded.

The tasks are scripts that can be implemented either in PHP or in Python.

[#lifecycle]
=== The lifecycle of a workflow

There are 3 main type of workflow processes: 

- CREATE: to execute an automated process and create a new instance of the workflows
- UPDATE: to execute an automated process that will (but it's not mandatory) update the state of the process
- DELETE: to execute an automated process that will also remove the instance of the workflow

The status a normal process execution is defined by the implementation of the tasks and it's the responsibility of the developer to handle the termination status. As a developer, you have 3 statuses, defined by constants in PHP or Python, that you can use in your task to define the condition for transiting from a task to the next one.

- ENDED: the execution was successful, the next task will be executed and if it was the last task, the process will be marked as "Success".
- WARNING: the execution was successful but some warning were raised, the next task will be executed  and if it was the last task, the process status will be displayed as "Warning".
- FAILED: the execution failed, the process execution will stop at the current task and the process status will be noted as "Failed".

NOTE: these documentations to get more details and code samples on this topic: link:workflow_php_sdk{outfilesuffix}[PHP SDK] and link:workflow_python_sdk{outfilesuffix}[Python SDK]

[#context]
=== How to persist the state of a workflow instance

The variables are used to define the current state of a workflow instance, this state is maintained in a context which is persisted in the database.

For each workflow instance, the variable and their values are stored in the database in a context.
This context is accessible in read-write mode anytime in the process tasks in order to store a value of a variable or read a value from a variable.

.Example:
in Python: read a value from the context
[source, python]
----
context = Variables.task_call()
my_name = context['name']
----

set a value in the context
[source, python]
----
context['name'] = my_name
----

.Example:
in PHP: read a value from the context
[source, php]
----
$my_name = $context['name'];
----

set a value in the context
[source, php]
----
$context['name'] = $my_name;
----

The context is updated in the database after each task execution.
This is how variable values can be passed, during the execution of a process, from one task to another.

NOTE: by default, the variables that are declared a persisted in the context but you can also create local variables in the tasks and store them in the context.

== Editor Overview

To create a new workflow, connect to the link:developer_portal{outfilesuffix}[developer portal] and click "+ Create" on the workflow library swimlane.

=== Workflow information

Provide the information related to the workflow:

- Workflow Name: the name of the worklfow
- Description: a description of the workflow
- Workflow Variable Name: default to service_id (see below for more detail about this field). 
- Workflow Language: PHP or PYTHON (this cannot be edited)

=== Workflow variables

Use "+ Create Variable" to add variable to this workflow.

A variable can be used to store data in the context of the workflow instance and it can also be used to generate the user input fields when executing a process from the UI.

It is possible to define a variable for "internal" use and decide to keep is hidden from the end-user.

A variable has a name, a type and a display name.

==== Variable types
- String: will render as a text input field.
- Integer: will render as an integer input field.
- Boolean: will render as radio button.
- Device: will render as a list with the managed entities 

The "Advanced" tab will allo you to provide more control over the way variable fields are displayed: provide a list of default value, read-only or read-write, visible or hidden,...

=== Workflow processes

A workflow can have as many processes as needed. The processes provide the "public" functions exposed by a workflow either with the UI or the link:rest_api{outfilesuffix}[REST API].

To create a process, click on the "+" and provide a name and a type (CREATE, UPDATE or DELETE)

NOTE: the other types listed in the UI are not supported yet.

==== Tasks

The tasks are the smallest execution unit of a workflow. 

A process can have as many tasks as needed and althought it's possible to implement a process with a single task, splitting the overall process execution into smaller tasks will ease the code maintenance and the execution monitoring.

Depending on the workflow language selected when creating the workflow, the task should be implemented either in Python or in PHP.

When creating a new task, the UI will propulate the code editor with a pre-defined code template that you can use to start coding your tasks.

===== PHP template

[source,php]
----
<?php

require_once '/opt/fmc_repository/Process/Reference/Common/common.php';                     <1>

function list_args()                                                                        <2>
{
  create_var_def('var_name', 'String');
  create_var_def('var_name2', 'Integer');
}

check_mandatory_param('var_name');                                                          <3>

/**
 * $context => workflow context variable one per Instance
 * ENTER YOUR CODE HERE
 */
$context['var_name2'] = $context['var_name2'] + 1;                                          <4>

if ($context['var_name2'] % 2 === 0) {                                                      <5>
	$ret = prepare_json_response(FAILED, 'Task Failed', $context, true);
	echo "$ret\n";
	exit;
}

task_success('Task OK');   // or task_error('Task FAILED');                                 <6>
?>
----

<1> include the link:workflow_php_sdk{outfilesuffix}[php SDK libraries].
<2> function to list all the parameters required by the task and that should also be rendered as user input field.
<3> function to check whether all the mandatory parameters are present in user input.
<4> code example: assign a variable with a modified value from another variable.
<5> code example: task execution status will depend on the value of a variable
<6> end of the task.
