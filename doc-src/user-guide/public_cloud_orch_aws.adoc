= VNF Orchestration on AWS
:doctype: book
:imagesdir: ./resources/
ifdef::env-github,env-browser[:outfilesuffix: .adoc]
:toc: left
:toclevels: 4 
:source-highlighter: pygments



== Prerequisites

=== AWS IAM configuration

The demo uses microservices, adapter and workflows to automate the orchestraion of the VNF on AWS. These rely on the AWS API to execute and will require an authentication.

To run this demo use case, you need to make sure that you have an AWS IAM (Identity and Access Management) user with an access key.
The access key will be used when creating the AWS link:managed_entities{outfilesuffix}[managed entity] (see below) 

==== IAM policy
The use should be granted with a policy that allows enough privileges to manage EC2 and VPC programmatically. If you can, the easiest way to acheive this is to allow all EC2 and VPC actions.

If this is not possible then here is the list of actions to be allowed to use the link:https://github.com/openmsa/Workflows[workflow] and the link:https://github.com/openmsa/Microservices[microservices] available on github.com/openmsa

- DescribeNetworkInterfaces
- AttachNetworkInterface
- CreateNetworkInterface
- DeleteNetworkInterface
- DescribeInstances
- TerminateInstances
- DescribeSecurityGroups
- CreateSecurityGroup
- DeleteSecurityGroup
- DescribeAddresses
- DescribeSubnets
- DescribeVpcs
- CreateVpc
- DeleteVpc
- RunInstances
- RebootInstances
- WaitUntilInstanceRunning
- StartInstances
- StopInstances
- CreateTags

image:images/aws_iam_policy.png[width=1000px]

NOTE: if you extend the workflow or the microservices to provide a larger functional coverage, you may have to update the policy for accessing the AWS REST API.

==== IAM user

Create a user and attach the policy to this user

image:images/aws_iam_user.png[width=1000px]

You will also need an access key for this user in order to make secure REST API call from the {$product_name}

image:images/aws_iam_user_key.png[width=1000px]

[#me_creation]
== Create a managed entity for an AWS region

The VNF automation workflow for AWS uses both microservices and direct AWS API calls to implement the VNF orchestration. In both cases AWS user credentials (the access key created up above) is required. These credentials are provided at the AWS managed entity creation form in the username and user password fields.

When creating the AWS managed entity, make sure that you select AWS / Generic for the Vendor / Model.

The AWS managed entity is also used to define the link:https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-regions[region] where the VNF will run. The region information is set at the managed entity creation form, in the hostname field. The region should be the one set in the AWS console URL.

The last information for managing an AWS region with the {$product_name} is the management IP address. The management IP address can be found by taking the hostname from the AWS console URL from your browser.

.Example:
with the AWS console URL https://eu-west-2.console.aws.amazon.com/ec2/v2/home?region=eu-west-2 the region is *eu-west-2* and the IP address is *52.94.48.109*
----
$ ping eu-west-2.console.aws.amazon.com
PING console.eu-west-2.amazonaws.com (52.94.48.109): 56 data bytes
64 bytes from 52.94.48.109: icmp_seq=0 ttl=236 time=20.272 ms
----

image:images/aws_me_creation_form.png[width=1000px]

Create and activate the link:managed_entities{outfilesuffix}[managed entity]. The activation, implemented by the link:https://github.com/openmsa/Adapters/tree/2.2.0GA/adapters/aws_generic[AWS Generic adapter] will try to call some REST API during it's process. A successful activation ensure that the information provided during the creation of the managed entity are correct and that the credentials are valid by calling 2 API: DescribeInstances and DescribeVpcs:

[source, php]
----
public function do_connect()
  {
    $network = get_network_profile();
    $sd = &$network->SD;
    $this->key = $this->sd_login_entry;
    $this->secret = $this->sd_passwd_entry;
    $this->region = $sd->SD_HOSTNAME;
    
    $cmd = "Aws\Ec2\Ec2Client#describeInstances#{ \"MaxResults\" : 5 }";
    $result = $this->sendexpectone(__FILE__ . ':' . __LINE__, $cmd, "");    

    $cmd = "Aws\Ec2\Ec2Client#describeVpcs#";
    $result = $this->sendexpectone(__FILE__ . ':' . __LINE__, $cmd, "");    
----

NOTE: the activation phase will *not* check that the AWS user is authorized for every AWS API needed for the orchestration (see list above).

== Create a deployment setting to use microservices

Create a new deployment setting in your current subtenant, set the vendor to AWS and select the microservices below:

- Instances
- Network Interfaces
- Security Groups
- Subnet
- VPC

Add your managed entity to deployment setting and verify that you can use the microservices by browsing to the managed entity page and selecting the tab "Configure". 

Use the action "Synchronize with Managed Entity" to import the AWS "config". On a new, blank AWS region, you should at least see the default VPC.

NOTE: if the synchonisation seems to have no effect, you can try to activate the managed entity once more and run the synchronisation again.