= Quickstart 
:front-cover-image: image:quickstart-front-cover.pdf[]
ifndef::imagesdir[:imagesdir: images]
ifdef::env-github,env-browser[:outfilesuffix: .adoc]
:toc: top
:toclevels: 3

//OK HTML 
ifdef::html[]
:includedir: doc-src/user-guide

[.stripes-none,cols="1,10",frame=none,grid=none,options="noheader",width="50%"]
|===
| image:pdf_icon.png[width=32px] | link:../pdf/user-guide/quickstart.pdf[download as PDF,window=_blank]
|===

endif::[]

// OK PDF
ifdef::pdf[]
:includedir: .
endif::[]

The quickstart covers how you can quickly get started using {product_name} by installing a mini lab.

ifeval::["{format}" == "html"]

== Video tutorial
This video details the steps for installing and activating the mini lab.

video::A7zT-AZf2cg[youtube,width=600px,height=360] 

endif::[]

[#prerequisites]
== Prerequisites
The following prerequisites are required for a successful use of {product_name}:

. A recent version of Git. 
. A working docker and docker-compose setup
* link:https://docs.docker.com/install/[Docker]
* link:https://docs.docker.com/compose/install/[Docker Compose]

== Setup requirements

=== Internet Resources
 * Ensure you have access from HOST machine(s) to:
 ** https://github.com
 ** https://hub.docker.com

=== Hardware Resources

.on a PC (for lab experimentation)
- minimum memory:4GB (8GB to be comfortable), 2CPU, 100GB

NOTE: with less that 4GB of memory, the {product_name} may not function properly.

.on a production environment 
- minimum 16GB, 4CPU, 200GB

=== Docker optional custom configuration

The custom configuration below may not be needed depending on your host computer and you intended use of the {product_name}. If you are just running the product for evaluation purpose or training, don't worry too much about these at first.

In a production environment, these custom configuration may be mandatory to allow your setup to support a higher workload.

==== Docker for Linux (or Linux VM)

----
sudo sysctl -w vm.max_map_count=262144
echo 'vm.max_map_count = 262144' > /etc/sysctl.d/50-msa.conf
sudo sysctl -p /etc/sysctl.d/50-msa.conf
----

==== Docker for Mac

From the command line, run:
----
screen ~/Library/Containers/com.docker.docker/Data/vms/0/tty
----	
Press enter and use`sysctl` to configure vm.max_map_count:
----
sysctl -w vm.max_map_count=262144
----	
To exit the screen session, type Ctrl a d.

==== Docker for Windows

----
docker-machine create -d virtualbox  \
	--virtualbox-cpu-count=2 \
	--virtualbox-memory=8192 \
	--virtualbox-disk-size=50000 \
	default
----

In the docker VM, do as for Linux host above:
----
sudo sysctl -w vm.max_map_count=262144
sudo tee -a /etc/sysctl.conf <<< "vm.max_map_count=262144"
----

== Mini lab creation

[#step1]
=== Step 1: creation

Create the mini lab: clone the quickstart git repository from Github, download and run the {product_name} from DockerHub. 

1. `git clone https://github.com/ubiqube/quickstart.git`
2. `cd quickstart`
3. `git checkout tags/{revnumber} -b {revnumber}`
4. `docker-compose up -d`

NOTE: If you are already running the {product_name} and wish to upgrade it to a new version check the link:#upgrade[documentation below]

NOTE: The architecture of the mini lab is detailed in this link:../admin-guide/architecture_overview{outfilesuffix}[documentation].

[#step2]
=== Step 2: install the trial license 

On link:https://ubiqube.com/free-trial/[ubiqube.com], fill the form to receive a trial license by email.

Open link:https://localhost/[window=_blank] and connect with username `ncroot` and password `ubiqube`.

Browse to "Settings" in the left menu and upload the free trial license you received.

NOTE: use localhost if you are using your PC as the docker host, otherwise use the IP address assigned to the docker host.

[#step3]
=== Step 3: the libraries (Microservices, Workflows and Adapters) from github.com/openmsa

`docker-compose exec msa_dev /usr/bin/install_libraries.sh all`

At the end of the script execution, you need to restart the API container and the CoreEngine container:

`docker-compose restart msa_api && docker-compose restart msa_sms`

NOTE: more explanations on the script `install_libraries.sh` can be found link:#install_librairies[here].

[#step4]
=== Step 4: provision the mini lab with tenants, managed entities, etc.

The mini lab comes with 2 Linux container (linux_me / 172.20.0.101 and linux_me_2 / 172.20.0.102) for experimentation.

Credentials for the Linux machine are:

 - username: `msa`
 - password: `ubiqube`

In order to ease your discovery of {product_name}, we are providing a script that will create the mini lab environment for you: 

- 1 tenant - BladeRunner
- 1 subtenant - Tyrell Corporation
- 2 managed entities to manage the Linux container - linux_me
- some microservices and workflows to start configuring the managed entity - users, firewall, etc.

To create the mini lab environment, run the CLI command from where you have cloned the quickstart Github project:

```
$ docker-compose exec msa_dev /usr/bin/create_mini_lab.sh
```

[#step5]
=== Step 5: start using the {product_name}

Browse: link:https://localhost/[window=_blank] and connect with username `ncroot` and password `ubiqube`. 

== Mini lab detailed description
=== Use case 1: firewall orchestration on Linux

This lab use case will show you in a simple way how you can use {product_name} to automate the configuration of iptables-based firewall policy on the Linux containers included in the mini lab.

The development of this use case is detailed in this guide: Firewall Policy Automation

You can use the guide to recreate the use case step by step or you may also directly run the use case with the workflow and microservices that are installed in the mini-lab.

For that, you'll have to select the subtenant named "TYRELL CORPORATION," click on the link "Automation" on the left menu and select the tab "Workflows." The workflow to use is "Simple Firewall (Python)."

ifeval::["{format}" == "html"]

video::QRwv78yQWss[youtube,width=600px,height=360]

endif::[]

== Mini lab additional info

[#upgrade]
=== Fresh install or upgrade ?

The quickstart repository is maintained on https://github.com/ubiqube/quickstart and the latest version is available on the branch master.

If you are upgrading your {product_name}, you can either do a clean install for the quickstart by removing your docker containers and the quickstart directory and go to step 2. above or you can update your quickstart with `cd quickstart` and checkout the latest version you want to upgrade to.

NOTE: In case you have updated the {product_name} with `docker-compose up -d` or `docker-compose pull`, you might experience cache issues (for instance, your changes may not be reflected on the UI). To solve that, you can clean your browser cache, or use a browser private session.

=== Upgrade version N to N+1

Starting from it's version 2.2.0, the quickstart project provides a script `upgrade.sh` for taking care of possible upgrade actions such as recreate some volumes, execute some database specific updates, update the libraries,...

Let's say that you are running the version {revnumber-prev}, to upgrade to the version {revnumber} you need to follow these steps:

1. `cd quickstart`
2. `git checkout master`
3. `git pull`
4. `git fetch --all --tags`
5. `git checkout tags/{revnumber} -b {revnumber}`
6. `./scripts/upgrade.sh` 

NOTE: when running the upgrade script, it will ask you if you want your local libraries to be updated with the latest version from the community. If you answer 'y', the update will be done automatically. You can also do the update later manually on the container `msa_dev`.

==== Note for Windows user

If you are running docker natively on Windows, the script upgrade.sh may not work. In that case you need to execute manually the Docker CLI commands to upgrade your setup:

If your original version is 2.1, plz refer to upgrade script first provided with 2.2.0 GA. In any cases, perform those commands

1. `docker-compose down`
2. `docker-compose up -d --build`
3. `docker-compose exec msa_dev /usr/bin/install_libraries.sh all`
4. `docker-compose restart msa_api && docker-compose restart msa_sms`
5. `docker exec -it -u root msa_api crond`
6. `docker-compose exec msa_dev /usr/bin/migrate_bpmn.sh -r`
7. `docker-compose exec msa_dev /usr/bin/clean_old_topology_instances.sh`
8. `docker exec -u root -w /home/install/scripts/ -it  msa_es bash -c './install.sh'`
9. `docker exec -u root -w /home/install/ -it  msa_kibana bash -c 'php install_default_template_dash_and_visu.php'`

=== Install a specific version

For each release of the {product_name}, there is a tag that you can use if you need to install a specific version of the product.

To install a tagged version, you can checkout the tag and go to the install steps above.

For example, the CLI command below will checkout the quickstart for the release {revnumber}.

`git checkout tags/{revnumber} -b {revnumber}`

The releases and tags are available link:https://github.com/ubiqube/quickstart/releases[here]

[#install_libraries]
=== install_libraries script

The script `install_libraries.sh` is installed in the container link:../admin-guide/architecture_overview{outfilesuffix}#_msa_dev[msa_dev]

This script is designed to populate the libraries for a fresh install or to update your libraries with the latest version from Github.

[source, shell]
----
$ docker-compose exec msa_dev /usr/bin/install_libraries.sh --help
usage: install_libraries.sh all|ms|wf|da|py|mano|quickstart [--lic] [-y]

this script installs some libraries available @github.com/openmsa

Commands:
all:          install everything: workflows, microservices and adapters
ms:           install the microservices from https://github.com/openmsa/Microservices
wf:           install the workflows from https://github.com/openmsa/Workflows
da:           install the adapters from https://github.com/openmsa/Adapters
mano:         install/update the python-sdk from https://github.com/openmsa/etsi-mano
py:           install/update the python-sdk from https://github.com/openmsa/python-sdk
quickstart:   install/update the local quickstart from https://github.com/ubiqube/quickstart

Options:
--lic:     force license installation
-y:           answer yes for all questions
----

In case of calling this script on an existing setup, it will take care of merging the code from the Github master branch into your local development branch. With the option `-y`, an automated merge will be attempted, without the option, the script will ask for user input.

IMPORTANT: when running the script on an existing setup, use the option `--no-lic` to make sure that your current license is not overwritten by a new trial license. 

ifeval::["{format}" == "html"]

:leveloffset: +1

include::{includedir}/libraries_packages.adoc[]

endif::[]
